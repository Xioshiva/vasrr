uniform mat4 worldView,world,view;uniform vec3 cameraPosition;uniform samplerCube envMap0,envMap1,envMap2,envMap3;uniform sampler2D normalMap,physicalMap;uniform mat4 invView;uniform int useNormal;uniform vec4 diffusColor,ambientColor;uniform float amplification,flatShininess,scratchVisibility;uniform mat4 anomalies[25];uniform int anomalyInstances;varying vec3 reflectedVector;varying vec4 vPosition;varying vec3 vNormal;varying vec2 vUv;varying vec3 posEye;varying mat3 vTBN;
#define M_PI 3.1415926535897932384626433832795
vec3 v(mat3 v,vec3 i,float y){i=i*2.-1.;if(i.z==1.)i.x=0.,i.y=0.;i.x=i.x*y;i.y=i.y*y;return v*i;}vec3 v(vec3 v){vec4 i=vec4(0.,-1./3.,2./3.,-1.),f=mix(vec4(v.zy,i.wz),vec4(v.yz,i.xy),step(v.z,v.y)),a=mix(vec4(f.xyw,v.x),vec4(v.x,f.yzx),step(f.x,v.x));float m=a.x-min(a.w,a.y),y=1e-10;return vec3(abs(a.z+(a.w-a.y)/(6.*m+y)),m/(a.x+y),a.x);}vec3 f(vec3 v){vec4 a=vec4(1.,2./3.,1./3.,3.);vec3 i=abs(fract(v.xxx+a.xyz)*6.-a.www);return v.z*mix(a.xxx,clamp(i-a.xxx,0.,1.),v.y);}vec4 f(vec3 i,vec3 a,float y,float x){vec3 z=v(vTBN,i.xyz,y),f=normalize(vec3(view*vec4(z,0.))),r;r=vec3(invView*vec4(reflect(a,f),0.));vec4 m=vec4(0.,0.,0.,0.),e=vec4(0.,0.,0.,0.),p=vec4(0.,0.,0.,0.),s=vec4(0.,0.,0.,0.);x=1.-x;if(x>2./3.)s=textureCube(envMap3,r);if(x>1./3.)p=textureCube(envMap2,r);if(x<2./3.)e=textureCube(envMap1,r);if(x<1./3.)m=textureCube(envMap0,r);float w=clamp(x-2./3.,0.,1./3.)*3.,c=clamp(x-1./3.,0.,1./3.)*3.,l=clamp(x,0.,1./3.)*3.;vec4 n=mix(m,mix(e,mix(p,s,w),c),l);return n;}void main(){vec3 v=normalize(posEye);int i=0;float a=0.,r=1.;vec2 m=vec2(0.,0.),y=vUv;for(int x=0;x<anomalyInstances;x++){if(vUv.x>=anomalies[x][0][0]&&vUv.y>=anomalies[x][0][1]&&vUv.x<=anomalies[x][1][0]&&vUv.y<=anomalies[x][1][1])i=1,r=anomalies[x][2][2],y.x=anomalies[x][0][2]+(y.x-anomalies[x][0][2])*7.8,y.y=anomalies[x][0][3]+(y.y-anomalies[x][0][3]);}vec4 x;if(useNormal==1&&i==1){vec4 e=texture2D(normalMap,y),s=texture2D(physicalMap,y);a=round(1./s.z);vec4 z=f(vec3(0.,0.,1.),v,1.,flatShininess*s.y);if((a==1.||a==2.)&&e.z<=.999999){vec4 n;if(a==2.)x=f(e.xyz,v,1.,s.y);else if(s.x<1.)n=f(e.xyz,v,1.,0.)*scratchVisibility,x=n,x=x*.5+x*s.x;else{n=f(e.xyz,v,1.,flatShininess*s.y)*scratchVisibility;if(e.w>.9){vec4 p=f(e.xyz,v,-1.,flatShininess*s.y)*scratchVisibility;x=n/2.+p/2.;}else x=n;x=mix(z,x,1.-e.w);}}else x=z;vec4 p=diffusColor;if(a==4.)p=mix(vec4(e.xyz,1.),p,s.y);gl_FragColor=mix(x*p*amplification+ambientColor,p,s.w);}else{vec4 n=f(vec3(0.,0.,1.),v,1.,flatShininess);x=n;gl_FragColor=x*diffusColor*amplification+ambientColor;}}